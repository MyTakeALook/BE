<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
</head>

<style>
  *{ margin: 0; padding: 0; }

  li { list-style: none; }

  .header { font-size: 14px; padding: 15px 0; background: #F18C7E; color: white; text-align: center; border-radius: 10px 10px 0 0;}

  .chat ul { width: 100%; }
  .chat ul li { width: 100%; }
  .left { text-align: left; }
  .right { text-align: right; }

  .chat ul li > div { font-size: 13px; }
  .sender { margin: 10px 20px 0 20px; font-weight: bold; }
  .message { display: inline-block; word-break:break-all; margin: 5px 20px; max-width: 75%; border: 1px solid #888;
    padding: 10px; border-radius: 5px; background-color: #FCFCFC; color: #555; text-align: left; }
</style>

<body>

<div style="position:relative; width:50rem; height:50rem; margin:auto; border: 1px solid #D5D5D5; border-radius: 15px; overflow-y: scroll;">
  <div class="header">
    들어옴?????
  </div>

  <div id="participantNumber">
  </div>

  <div id="chat">
    <ul>

    </ul>
  </div>

  <div style="position:absolute; bottom:0; margin-left:2.5rem;">
    <input type="text" style="width: 500px;height: 32px;font-size: 15px;border: 0;border-radius: 15px;
            outline: none;padding-left: 10px;background-color: rgb(233, 233, 233); text-align: center" placeholder="메세지를 입력해주세요" id="sendText">

    <button type="button" style="border:none; color: #4C4C4C; height: 32px; padding:0px 20px; border-radius:10px;
            background-color:#B2CCFF; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2); margin-left:15px;" onclick="sendMessage()">
      보내기
    </button>
  </div>
</div>
</body>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="/webjars/sockjs-client/1.1.2/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.3-1/stomp.min.js"></script>
<script>
  const auth = getToken();

  let userName = localStorage.getItem('userName');
  let roomUUID = localStorage.getItem('roomUUID');

  $(document).ready(function () {
    // HTML 문서를 로드할 때마다 실행합니다.
    roomPage();
  })

  function roomPage() {
    $.ajax({
      type: "POST",
      url: "/chat/room/enter/" + roomUUID,
      data: {
        roomUUID : roomUUID
      },
      beforeSend: function (xhr) {
        xhr.setRequestHeader("Authorization", auth);
      },
      success: function (response) {
        alert("참가 성공???");
        console.log(response);

        $('#chat').empty();

        for (let i = 0; i < response.length; i++) {
          let tempHtml;
          if (userName == response[i].sender) {
            tempHtml = makeHtmlMessageRight(response[i]);
          } else {
            tempHtml = makeHtmlMessageLeft(response[i]);
          }
          $('#chat').append(tempHtml);
        }
      }
    });
  }

  let sock = new SockJS("/ws-stomp"); //new SockJS()를 사용하여 아까 핸들러에서 지정해준 endPoint를 사용하여 연결을 해준다.
  let ws = Stomp.over(sock);

  ws.connect({}, function(frame) {
    ws.send("/pub/chat/connect", {}, JSON.stringify({roomUUID:roomUUID})); //receiver:participant,

    ws.subscribe("/sub/chat/room/" + roomUUID, function(message) {
      let receive = JSON.parse(message.body);
      alert("구독 메세지");
      console.log(receive);
      if (receive.participantNumber) {
        receiveParticipantNumber(receive);
      } else {
        receiveMessage(receive);
      }
    });
  }, function(error) {
    alert("error"+error);
  });

  window.onbeforeunload = function () {
    $.ajax({
      type: "POST",
      url: "/chat/room/exit/" + roomUUID,
      data: {
        roomUUID : roomUUID
      },
      beforeSend: function (xhr) {
        xhr.setRequestHeader("Authorization", auth);
      },
      success: function (response) {
        alert("퇴장 성공???");
      }
    });
    ws.send("/pub/chat/disconnect", {}, JSON.stringify({roomUUID:roomUUID}));
  };

  function sendMessage() {
    let sendText = $('#sendText').val();
    ws.send("/pub/chat/message", {}, JSON.stringify({userJWT:auth, message:sendText, roomUUID:roomUUID})); //receiver:participant,
  }

  function receiveMessage(receive) {
    let tempHtml;
    if (userName == receive.sender) {
      tempHtml = makeHtmlMessageRight(receive);
    } else {
      tempHtml = makeHtmlMessageLeft(receive);
    }
    $('#chat').append(tempHtml);
  }

  function makeHtmlMessageRight(receive) {
    return `<li class="right">
                <div class="sender">${receive.sender}</div>
                <div class="message">${receive.message}</div>
            </li>`
  }

  function makeHtmlMessageLeft(receive) {
    return `<li class="left">
                <div class="sender">${receive.sender}</div>
                <div class="message">${receive.message}</div>
            </li>`
  }

  function receiveParticipantNumber(receive) {
    $('#participantNumber').empty();
    let tempHtml;
    tempHtml = makeHtmlParticipantNumber(receive);
    $('#participantNumber').append(tempHtml);
  }

  function makeHtmlParticipantNumber(receive) {
    return `<span>
                채팅자 수 : ${receive.participantNumber}
            </span>`
  }

  function  getToken() {
    let cName = 'Authorization' + '=';
    let cookieData = document.cookie;
    let cookie = cookieData.indexOf('Authorization');
    let auth = '';
    if(cookie !== -1){
      cookie += cName.length;
      let end = cookieData.indexOf(';', cookie);
      if(end === -1)end = cookieData.length;
      auth = cookieData.substring(cookie, end);
    }
    return auth;
  }
</script>

</html>